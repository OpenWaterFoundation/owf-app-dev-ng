<mat-accordion>
  <mat-expansion-panel [expanded]="true" hideToggle>
    <mat-expansion-panel-header class="expansion-header"
    attr.data-cy="{{geoLayerViewGroup.geoLayerViewGroupId}}-expansion-panel-header">
      <mat-panel-title class="expansion-header-title"
      [class.expansion-header-title-doc]="geoLayerViewGroup.properties.docPath">
        {{geoLayerViewGroup.name}}
      </mat-panel-title>
      <mat-panel-description>
        <div *ngIf="geoLayerViewGroup.properties.docPath">

          <button mat-icon-button
          (click)="clickIconButtonOnly($event)"
          [matMenuTriggerFor]="geoLayerViewGroupMenu"
          matTooltip="Click to view layer group menu options"
          [matTooltipShowDelay]="750"
          matTooltipPosition="above"
          data-cy="geoLayerViewGroupKebab">
            <mat-icon class="white-dots">more_vert</mat-icon>
          </button>
          <mat-menu #geoLayerViewGroupMenu="matMenu">
            <button mat-menu-item
            (click)="openDocDialog(geoLayerViewGroup.properties.docPath, geoLayerViewGroup.geoLayerViewGroupId, geoLayerViewGroup.name)"
            [disabled]="geoLayerViewGroup.properties.docPath | menuDisable"
            matTooltip="Click to view layer group documentation"
            [matTooltipShowDelay]="750"
            matTooltipPosition="after"
            data-cy="geoLayerViewGroupInformation">
              <i class="fa fa-info-circle fa-2x info-circle"></i>
              Information
            </button>
          </mat-menu>

        </div>
      </mat-panel-description>
    </mat-expansion-panel-header>

    <!-- Here go through each geoLayerView and just show them. No need for trying
      to dynamically create each one as a component. Just show each one of them here -->
    <div *ngFor="let geoLayerView of geoLayerViewGroup.geoLayerViews; let numOfViews = index"
    class="layer-control-container">

      <div class="layer-control">
        <div *ngIf="geoLayerView.properties.refreshInterval !== ''"
        class="layer-title"
        matTooltip="Time since last refresh: {{lastRefresh[geoLayerView.geoLayerId]}}"
        matTooltipPosition="above">
          {{geoLayerView.name}}
        </div>

        <div *ngIf="geoLayerView.properties.refreshInterval === ''" class="layer-title">
          {{geoLayerView.name}}
        </div>

        <div class="layer-viz-icon">

          <button mat-icon-button class="layer-viz-button" [disabled]="true"
          [hidden]="geoLayerView.eventHandlers | menuDisable: 'vizCheck'">
            <!-- For displaying a graph looking icon in the layer control -->
            <mat-icon matTooltip="Click features on this layer for data visualization"
            [matTooltipShowDelay]="750">
              timeline
            </mat-icon>
          </button>
          
        </div>

        <div class="layer-kebab-menu">
          <button mat-icon-button [matMenuTriggerFor]="geoLayerMenu"
          matTooltip="Click to view layer menu options" [matTooltipShowDelay]="750"
          attr.data-cy="{{geoLayerView.geoLayerId}}-kebab">
            <mat-icon class="green-dots">more_vert</mat-icon>
          </button>
          <mat-menu #geoLayerMenu="matMenu">
            <button mat-menu-item
            (click)="openDocDialog(geoLayerView.properties.docPath, geoLayerView.geoLayerViewId, geoLayerView.name)"
            [disabled]="geoLayerView.properties.docPath | menuDisable"
            attr.data-cy="{{geoLayerView.geoLayerId}}-kebab-information">
              <i class="fa fa-info-circle fa-2x info-circle"></i>
              Information
            </button>
            <!-- TODO: jpkeahey 2020.10.30 - Uncomment out to try disabling the data table button when
              a layer is toggled off on the Leaflet map -->
            <!-- [disabled]="geoLayerView.geoLayerId | menuDisable: 'dataTableCheck': 'true'" -->
            <button mat-menu-item
            (click)="openDataTableDialog(geoLayerView)"
            [hidden]="allFeatures[geoLayerView.geoLayerId] | menuDisable"
            attr.data-cy="{{geoLayerView.geoLayerId}}-kebab-data-table">
              <i class="fa fa-table fa-2x"></i>
              Data Table & Search
            </button>

            <button mat-menu-item
            (click)="openImageGalleryDialogFromKebab(geoLayerView.geoLayerId, geoLayerView)"
            [hidden]="geoLayerView.properties.imageGalleryEventActionId | menuDisable"
            attr.data-cy="{{geoLayerView.geoLayerId}}-kebab-image-gallery">
              <i class="fa fa-picture-o fa-2x"></i>
              Image Gallery
            </button>

            <button mat-menu-item
            (click)="openPropertyDialog(geoLayerView.geoLayerId, geoLayerView.name)"
            [disabled]="allFeatures[geoLayerView.geoLayerId] | menuDisable"
            [hidden]="geoLayerView.properties.imageBounds | menuDisable : 'imageCheck'"
            attr.data-cy="{{geoLayerView.geoLayerId}}-kebab-properties">
              <i class="fa fa-list fa-2x"></i>
              Properties
            </button>
            <!-- [disabled]="mainMap | menuDisable : 'selectedCheck' : geoLayerView.geoLayerId" -->
            <!-- [disabled]="checkIfHighlighted(geoLayerView.geoLayerId)" -->
            <button mat-menu-item
            (click)="clearSelections(geoLayerView.geoLayerId)"
            [disabled]="allFeatures[geoLayerView.geoLayerId] | menuDisable"
            [hidden]="geoLayerView.properties.imageBounds | menuDisable : 'imageCheck'"
            matTooltip="Clear highlighted features in the layer"
            matTooltipPosition="after"
            matTooltipShowDelay="750"
            attr.data-cy="{{geoLayerView.geoLayerId}}-kebab-clear-selection">
              <i class="fa fa-dot-circle-o fa-2x"></i>
              Clear Selection
            </button>

            <!-- <button mat-menu-item
                      (click)="findFromAddress(geoLayerView.geoLayerId)"
                      matTooltip="Zoom to coordinates of an address"
                      matTooltipPosition="after"
                      matTooltipShowDelay="750">
                <i class="fa fa-building fa-2x"></i>
                Find From Address
              </button> -->
          </mat-menu>

        </div>

        <div class="layer-toggle">
          <!-- <mat-slide-toggle id="{{geoLayerView.geoLayerId}}-slider"
                            [(ngModel)]="isChecked"
                            (change)="toggleLayerTest($event, geoLayerView.geoLayerId)">
          </mat-slide-toggle> -->

          <label matTooltip="Show/hide this layer on the map" matTooltipShowDelay="750">
            <input id="{{geoLayerView.geoLayerId}}-slider" type="checkbox"
            [attr.checked]="geoLayerView.properties.selectedInitial | menuDisable: 'toggleCheck' : geoLayerView.geoLayerId"
            (click)="toggleLayer(geoLayerView.geoLayerId, geoLayerViewGroup.geoLayerViewGroupId)">
            <span class="slider round"></span>
          </label>
        </div>

        <div class="layer-description" id="description-{{geoLayerView.geoLayerId}}">
          {{geoLayerView.description}}
        </div>
      </div>

      <!-- Check to see if the geoLayerSymbol is missing to display a default symbol in the legend. -->
      <div *ngIf="!geoLayerView.geoLayerSymbol; else symbolExists"
      id="all-symbols-{{geoLayerView.geoLayerId}}">
        <svg class="layer-icon" width="18" height="18">
          <rect width="18" height="18" [ngStyle]="styleOuterShape(geoLayerView, 'sm')" />
        </svg>
      </div>
      <ng-template #symbolExists>

        <div id="all-symbols-{{geoLayerView.geoLayerId}}">
          <!-- SINGLE SYMBOL -->
          <div *ngIf="geoLayerView.geoLayerSymbol.classificationType.toUpperCase() === 'SINGLESYMBOL'">
            <!-- LINE -->
            <div *ngIf="getGeometryType(geoLayerView.geoLayerId).toUpperCase().includes('LINESTRING')">
              <svg class="layer-icon" height="10" width="25">
                <line x1="5" y1="5" x2="25" y2="5"
                  [ngStyle]="styleOuterShape(geoLayerView.geoLayerSymbol, 'ss')"
                  style="stroke-width:2" />
              </svg>
            </div>
            <!-- USER-PROVIDED DEFAULT MARKER -->
            <div *ngIf="geoLayerView.geoLayerSymbol.properties.symbolImage">
              <img class="layer-icon"
              [attr.src]="commonService.buildPath('symbolImagePath', [geoLayerView.geoLayerSymbol.properties.symbolImage])">
            </div>
            <!-- BUILT-IN DEFAULT MARKER -->
            <div *ngIf="geoLayerView.geoLayerSymbol.properties.builtinSymbolImage">
              <img class="layer-icon"
              [attr.src]="commonService.buildPath('builtinSymbolImagePath', [geoLayerView.geoLayerSymbol.properties.builtinSymbolImage])">
            </div>
            <!-- SYMBOL SHAPE -->
            <div *ngIf="geoLayerView.geoLayerSymbol.properties.symbolShape; else defaultLegend">
              <!-- SQUARE -->
              <div *ngIf="geoLayerView.geoLayerSymbol.properties.symbolShape.toUpperCase() == 'SQUARE'">
                <svg class="layer-icon" width="18" height="18">
                  <rect width="18" height="18"
                  [ngStyle]="styleOuterShape(geoLayerView.geoLayerSymbol, 'ss')" />
                </svg>
              </div>
              <!-- TRIANGLE & TRIANGLE-UP -->
              <div *ngIf="geoLayerView.geoLayerSymbol.properties.symbolShape.toUpperCase() == 'TRIANGLE' ||
                geoLayerView.geoLayerSymbol.properties.symbolShape.toUpperCase() == 'TRIANGLE-UP'">
                <svg class="layer-icon" height="18" width="18">
                  <polygon points="9,1 1,17 17,17"
                  [ngStyle]="styleOuterShape(geoLayerView.geoLayerSymbol, 'ss')" />
                </svg>
              </div>
              <!-- TRIANGLE-DOWN -->
              <div *ngIf="geoLayerView.geoLayerSymbol.properties.symbolShape.toUpperCase() == 'TRIANGLE-DOWN'">
                <svg class="layer-icon" height="18" width="18">
                  <polygon points="0,0 18,0, 9,18"
                  [ngStyle]="styleOuterShape(geoLayerView.geoLayerSymbol, 'ss')" />
                </svg>
              </div>
              <!-- DIAMOND -->
              <div *ngIf="geoLayerView.geoLayerSymbol.properties.symbolShape.toUpperCase() == 'DIAMOND'">
                <svg class="layer-icon" height="18" width="18">
                  <polygon points="0,9 9,18 18,9 9,0"
                  [ngStyle]="styleOuterShape(geoLayerView.geoLayerSymbol, 'ss')" />
                </svg>
              </div>
              <!-- CIRCLE -->
              <div *ngIf="geoLayerView.geoLayerSymbol.properties.symbolShape.toUpperCase() == 'CIRCLE'">
                <svg class="layer-icon" height="20" width="20">
                  <circle cx="10" cy="10" r="8"
                  [ngStyle]="styleOuterShape(geoLayerView.geoLayerSymbol, 'ss')" />
                </svg>
              </div>
              <!-- X -->
              <div *ngIf="geoLayerView.geoLayerSymbol.properties.symbolShape.toUpperCase() == 'X'">
                <svg class="layer-icon" height="18" width="18">
                  <line x1="0" y1="0" x2="18" y2="18"
                  [ngStyle]="styleOuterShape(geoLayerView.geoLayerSymbol, 'ss')" />
                  <line x1="18" y1="0" x2="0" y2="18"
                  [ngStyle]="styleOuterShape(geoLayerView.geoLayerSymbol, 'ss')" />
                </svg>
              </div>
            </div>
            <ng-template #defaultLegend>
              <!-- Image -->
              <div *ngIf="geoLayerView.geoLayerSymbol.properties.legendImagePath">
                <img [src]="geoLayerView.geoLayerSymbol.properties.legendImagePath">
              </div>
              <!-- Examine the geoLayerSymbol properties to determine if a default legend
                symbol needs to be shown. -->
              <div *ngIf="geoLayerView.geoLayerSymbol.properties.symbolImage === undefined &&
                geoLayerView.geoLayerSymbol.properties.builtinSymbolImage === undefined &&
                geoLayerView.geoLayerSymbol.properties.legendImagePath === undefined &&
                !getGeometryType(geoLayerView.geoLayerId).toUpperCase().includes('LINESTRING')">
                <svg class="layer-icon" width="18" height="18">
                  <rect width="18" height="18"
                  [ngStyle]="styleOuterShape(geoLayerView.geoLayerSymbol, 'ss')" />
                </svg>
              </div>
            </ng-template>
          </div>

          <!-- CATEGORIZED -->
          <div *ngIf="geoLayerView.geoLayerSymbol.classificationType.toUpperCase() ===  'CATEGORIZED'">
            <div *ngIf="categorizedLayerColors[geoLayerView.geoLayerId]">
              <div *ngFor="let location of categorizedLayerColors[geoLayerView.geoLayerId]; let i = index">
                <div *ngIf="(i % 2) === 0" class="cat-legend-features">
                  <!-- SQUARE will be default for polygons -->
                  <svg class="layer-icon" width="18" height="18">
                    <rect width="18" height="18"
                    [ngStyle]="styleOuterShape(categorizedLayerColors[geoLayerView.geoLayerId][i + 1], 'c')" />
                  </svg>
                  {{location}}
                </div>
              </div>
            </div>
          </div>

          <!-- GRADUATED -->
          <div *ngIf="geoLayerView.geoLayerSymbol.classificationType.toUpperCase() === 'GRADUATED'">
            <div *ngIf="graduatedLayerColors[geoLayerView.geoLayerId]">
              <div *ngFor="let graduatedSymbolLine of graduatedLayerColors[geoLayerView.geoLayerId];"
                class="grad-legend-features">
                <!-- SQUARE -->
                <div *ngIf="!geoLayerView.geoLayerSymbol.properties.symbolShape || geoLayerView.geoLayerSymbol.properties.symbolShape.toUpperCase() == 'SQUARE'">
                  <svg class='graduated-symbol' width="18" height="18">
                    <rect width="18" height="18"
                    [ngStyle]="styleInnerShape(graduatedSymbolLine, 'g')" />
                    <rect width="18" height="18"
                    [ngStyle]="styleOuterShape(graduatedSymbolLine, 'g')" />
                  </svg>
                  <div *ngIf="!graduatedSymbolLine.label; else displayLabel" class="grad-label">
                    {{graduatedSymbolLine | menuDisable: 'IMGradLabel' : geoLayerView.geoLayerId}}
                  </div>
                  <ng-template #displayLabel>
                    {{graduatedSymbolLine.label}}
                  </ng-template>
                </div>
                <!-- TRIANGLE -->
                <div *ngIf="geoLayerView.geoLayerSymbol.properties.symbolShape && geoLayerView.geoLayerSymbol.properties.symbolShape.toUpperCase() == 'TRIANGLE'">
                  <svg class='graduated-symbol' height="18" width="18">
                    <polygon points="9,1 1,17 17,17"
                    [ngStyle]="styleOuterShape(graduatedSymbolLine, 'g')" />
                  </svg>
                  <div *ngIf="!graduatedSymbolLine.label; else displayLabel" class="grad-label">
                    {{graduatedSymbolLine | menuDisable: 'IMGradLabel' : geoLayerView.geoLayerId}}
                  </div>
                  <ng-template #displayLabel>
                    {{graduatedSymbolLine.label}}
                  </ng-template>
                </div>
                <!-- CIRCLE -->
                <div *ngIf="geoLayerView.geoLayerSymbol.properties.symbolShape && geoLayerView.geoLayerSymbol.properties.symbolShape.toUpperCase() == 'CIRCLE'">
                  <svg class='graduated-symbol' height="20" width="20">
                    <circle cx="10" cy="10" r="8"
                    [ngStyle]="styleOuterShape(graduatedSymbolLine, 'g')" />
                  </svg>
                  <div *ngIf="!graduatedSymbolLine.label; else displayLabel"
                  class="grad-label">
                    {{graduatedSymbolLine | menuDisable: 'IMGradLabel' : geoLayerView.geoLayerId}}
                  </div>
                  <ng-template #displayLabel>
                    {{graduatedSymbolLine.label}}
                  </ng-template>
                </div>
              </div>
            </div>
          </div>

          <!-- <div>
              <mat-progress-bar mode="indeterminate"></mat-progress-bar>
            </div> -->
          <div *ngIf="isServerUnavailable(geoLayerView.geoLayerId)"
          class="geoLayerView-status">
            <mat-icon matTooltip="Data service unavailable. Refresh at a later time"
            [matTooltipShowDelay]="250" data-cy="serverUnavailable">warning</mat-icon>
          </div>
          <div *ngIf="isBadPath(geoLayerView.geoLayerId)" class="geoLayerView-status">
            <mat-icon [matTooltip]="'Bad Resource Path: ' + getBadPath(geoLayerView.geoLayerId)"
            [matTooltipShowDelay]="250" data-cy="badPath">warning</mat-icon>
          </div>

        </div>
      </ng-template>
      <!-- Check if the layer is the only one, or the last one. If not, draw the
        divider so there can be something separating two layers -->
      <div *ngIf="numOfViews !== geoLayerViewGroup.geoLayerViews.length - 1">
        <hr class="geoLayerView-divider">
      </div>

    </div>

  </mat-expansion-panel>
</mat-accordion>
