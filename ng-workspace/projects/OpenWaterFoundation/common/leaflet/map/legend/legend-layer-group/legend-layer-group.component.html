<mat-accordion>
  <mat-expansion-panel [expanded]="true" hideToggle>
    <mat-expansion-panel-header class="expansion-header"
    attr.data-cy="{{geoLayerViewGroup.geoLayerViewGroupId}}-expansion-panel-header">

      <div class="mat-panel-container">

        <div class="expansion-header-title-container">
          <span class="expansion-header-title">
            {{geoLayerViewGroup.name}}
          </span>
        </div>

        <div *ngIf="geoLayerViewGroup.properties.docPath" class="expansion-header-kebab">
          <button mat-icon-button
          (click)="clickIconButtonOnly($event)" [matMenuTriggerFor]="geoLayerViewGroupMenu"
          matTooltip="Click to view layer group menu options" [matTooltipShowDelay]="750"
          matTooltipPosition="above" data-cy="geoLayerViewGroupKebab">
            <mat-icon class="white-dots">more_vert</mat-icon>
          </button>
          <mat-menu #geoLayerViewGroupMenu="matMenu">
            <button mat-menu-item
            (click)="openDocDialog(geoLayerViewGroup.properties.docPath, geoLayerViewGroup.geoLayerViewGroupId, geoLayerViewGroup.name)"
            [disabled]="geoLayerViewGroup.properties.docPath | menuDisable"
            matTooltip="Click to view layer group documentation"
            [matTooltipShowDelay]="750"
            matTooltipPosition="after"
            data-cy="geoLayerViewGroupInformation">
              <fa-icon class="fa-icon" [icon]=faInfoCircle size="2xl"></fa-icon>
              Information
            </button>
          </mat-menu>
        </div>
      </div>

    </mat-expansion-panel-header>

    <!-- Here go through each geoLayerView and just show them. No need for trying
      to dynamically create each one as a component. Just show each one of them here -->
    <div *ngFor="let geoLayerView of geoLayerViewGroup.geoLayerViews; let numOfViews = index"
    class="layer-control-container">

      <div class="layer-control">

        <div class="layer-title">
          {{geoLayerView.name}}
        </div>

        <div class="layer-viz-icon">

          <button mat-icon-button class="layer-viz-button" [disabled]="true"
          [hidden]="geoLayerView.eventHandlers | menuDisable: 'vizCheck'">
            <!-- For displaying a graph looking icon in the layer control -->
            <mat-icon matTooltip="Click features on this layer for data visualization"
            [matTooltipShowDelay]="750">
              timeline
            </mat-icon>
          </button>
          
        </div>

        <div class="layer-kebab-menu">
          <button mat-icon-button [matMenuTriggerFor]="geoLayerMenu"
          matTooltip="Click to view layer menu options" [matTooltipShowDelay]="750"
          attr.data-cy="{{geoLayerView.geoLayerId}}-kebab">
            <mat-icon class="green-dots">more_vert</mat-icon>
          </button>
          <mat-menu #geoLayerMenu="matMenu">
            <button mat-menu-item
            (click)="openDocDialog(geoLayerView.properties.docPath, geoLayerView.geoLayerViewId, geoLayerView.name)"
            [disabled]="geoLayerView.properties.docPath | menuDisable"
            attr.data-cy="{{geoLayerView.geoLayerId}}-kebab-information">
              <fa-icon class="fa-icon" [icon]=faInfoCircle size="2xl"></fa-icon>
              Information
            </button>
            <!-- TODO: jpkeahey 2020.10.30 - Uncomment out to try disabling the data table button when
              a layer is toggled off on the Leaflet map -->
            <!-- [disabled]="geoLayerView.geoLayerId | menuDisable: 'dataTableCheck': 'true'" -->
            <button mat-menu-item
            (click)="openDataTableDialog(geoLayerView)"
            [hidden]="allFeatures[geoLayerView.geoLayerId] | menuDisable"
            attr.data-cy="{{geoLayerView.geoLayerId}}-kebab-data-table">
              <fa-icon class="fa-icon" [icon]=faTable size="2xl"></fa-icon>
              Data Table & Search
            </button>

            <button mat-menu-item
            (click)="openImageGalleryDialogFromKebab(geoLayerView.geoLayerId, geoLayerView)"
            [hidden]="geoLayerView.properties.imageGalleryEventActionId | menuDisable"
            attr.data-cy="{{geoLayerView.geoLayerId}}-kebab-image-gallery">
              <fa-icon class="fa-icon" [icon]=faImage size="2xl"></fa-icon>
              Image Gallery
            </button>

            <button mat-menu-item
            (click)="openPropertyDialog(geoLayerView.geoLayerId, geoLayerView.name)"
            [disabled]="allFeatures[geoLayerView.geoLayerId] | menuDisable"
            [hidden]="geoLayerView.properties.imageBounds | menuDisable : 'imageCheck'"
            attr.data-cy="{{geoLayerView.geoLayerId}}-kebab-properties">
              <fa-icon class="fa-icon" [icon]=faList size="2xl"></fa-icon>
              Properties
            </button>
            <!-- [disabled]="mainMap | menuDisable : 'selectedCheck' : geoLayerView.geoLayerId" -->
            <!-- [disabled]="checkIfHighlighted(geoLayerView.geoLayerId)" -->
            <button mat-menu-item
            (click)="clearSelections(geoLayerView.geoLayerId)"
            [disabled]="allFeatures[geoLayerView.geoLayerId] | menuDisable"
            [hidden]="geoLayerView.properties.imageBounds | menuDisable : 'imageCheck'"
            matTooltip="Clear highlighted features in the layer"
            matTooltipPosition="after"
            matTooltipShowDelay="750"
            attr.data-cy="{{geoLayerView.geoLayerId}}-kebab-clear-selection">
              <fa-icon class="fa-icon" [icon]=faCircleDot size="2xl"></fa-icon>
              Clear Selection
            </button>

            <!-- <button mat-menu-item
                      (click)="findFromAddress(geoLayerView.geoLayerId)"
                      matTooltip="Zoom to coordinates of an address"
                      matTooltipPosition="after"
                      matTooltipShowDelay="750">
                <fa-icon class="fa-building" [icon]=faBuilding size="2xl"></fa-icon>
                Find From Address
              </button> -->
          </mat-menu>

        </div>

        <div class="layer-toggle">
          <!-- <mat-slide-toggle id="{{geoLayerView.geoLayerId}}-slider"
                            [(ngModel)]="isChecked"
                            (change)="toggleLayerTest($event, geoLayerViewGroup, geoLayerView)">
          </mat-slide-toggle> -->

          <label matTooltip="Show/hide this layer on the map" matTooltipShowDelay="750">
            <input id="{{geoLayerView.geoLayerId}}-slider" type="checkbox" #slider
            [attr.checked]="geoLayerView.properties.selectedInitial | menuDisable : 'toggleCheck' : geoLayerView.geoLayerId"
            (click)="toggleLayer(geoLayerView.geoLayerId, geoLayerViewGroup.geoLayerViewGroupId)">
            <span class="slider round"></span>
          </label>
        </div>

      </div>

      <div [ngClass]="{'show-layer-info': slider.checked, 'hide-layer-info': !slider.checked}">

        <div class="layer-description" id="description-{{geoLayerView.geoLayerId}}">
          {{geoLayerView.description}}
        </div>

        <!-- Check to see if the geoLayerSymbol is missing to display a default symbol in the legend. -->
        <div *ngIf="'noSymbol' | symbolCheck : geoLayerView.geoLayerSymbol : layerClassificationInfo; else symbolExists"
        class="no-symbol-container"
        id="all-symbols-{{geoLayerView.geoLayerId}}">
          <svg class="layer-icon" width="18" height="18">
            <rect width="18" height="18" [ngStyle]="styleOuterShape('sm')"/>
          </svg>
        </div>
        <ng-template #symbolExists>

          <div id="all-symbols-{{geoLayerView.geoLayerId}}" class="single-symbol-container">
            <!-- SINGLE SYMBOL -->
            <div *ngIf="'SINGLESYMBOL' | symbolCheck : geoLayerView.geoLayerSymbol">
              <!-- LINE -->
              <div *ngIf="getGeometryType(geoLayerView.geoLayerId).toUpperCase().includes('LINESTRING')">
                <svg class="layer-icon" height="10" width="25">
                  <line x1="5" y1="5" x2="25" y2="5" [ngStyle]="styleOuterShape('ss', geoLayerView.geoLayerSymbol)"
                  style="stroke-width:2"/>
                </svg>
              </div>
              <!-- USER-PROVIDED DEFAULT MARKER -->
              <img *ngIf="geoLayerView.geoLayerSymbol.properties.symbolImage" class="layer-icon"
              [attr.src]="IMPath.sIP | buildPath : geoLayerView.geoLayerSymbol.properties.symbolImage">
              <!-- BUILT-IN DEFAULT MARKER -->
              <img *ngIf="geoLayerView.geoLayerSymbol.properties.builtinSymbolImage" class="layer-icon"
              [attr.src]="IMPath.bSIP | buildPath : geoLayerView.geoLayerSymbol.properties.builtinSymbolImage">
              <!-- SYMBOL SHAPE -->
              <div *ngIf="geoLayerView.geoLayerSymbol.properties.symbolShape; else defaultLegend">
                <!-- SQUARE -->
                <svg *ngIf="geoLayerView.geoLayerSymbol.properties.symbolShape.toUpperCase() == 'SQUARE'"
                class="layer-icon" width="18" height="18">
                  <rect width="18" height="18" [ngStyle]="styleOuterShape('ss', geoLayerView.geoLayerSymbol)"/>
                </svg>
                <!-- TRIANGLE & TRIANGLE-UP -->
                <svg *ngIf="geoLayerView.geoLayerSymbol.properties.symbolShape.toUpperCase() == 'TRIANGLE' ||
                geoLayerView.geoLayerSymbol.properties.symbolShape.toUpperCase() == 'TRIANGLE-UP'"
                class="layer-icon" height="18" width="18">
                  <polygon points="9,1 1,17 17,17" [ngStyle]="styleOuterShape('ss', geoLayerView.geoLayerSymbol)"/>
                </svg>
                <!-- TRIANGLE-DOWN -->
                <svg *ngIf="geoLayerView.geoLayerSymbol.properties.symbolShape.toUpperCase() == 'TRIANGLE-DOWN'"
                class="layer-icon" height="18" width="18">
                  <polygon points="0,0 18,0, 9,18" [ngStyle]="styleOuterShape('ss', geoLayerView.geoLayerSymbol)"/>
                </svg>
                <!-- DIAMOND -->
                <svg *ngIf="geoLayerView.geoLayerSymbol.properties.symbolShape.toUpperCase() == 'DIAMOND'"
                class="layer-icon" height="18" width="18">
                  <polygon points="0,9 9,18 18,9 9,0" [ngStyle]="styleOuterShape('ss', geoLayerView.geoLayerSymbol)"/>
                </svg>
                <!-- CIRCLE -->
                <svg *ngIf="geoLayerView.geoLayerSymbol.properties.symbolShape.toUpperCase() == 'CIRCLE'"
                class="layer-icon" height="20" width="20">
                  <circle cx="10" cy="10" r="8" [ngStyle]="styleOuterShape('ss', geoLayerView.geoLayerSymbol)"/>
                </svg>
                <!-- X -->
                <svg *ngIf="geoLayerView.geoLayerSymbol.properties.symbolShape.toUpperCase() == 'X'"
                class="layer-icon" height="18" width="18">
                  <line x1="0" y1="0" x2="18" y2="18" [ngStyle]="styleOuterShape('ss', geoLayerView.geoLayerSymbol)"/>
                  <line x1="18" y1="0" x2="0" y2="18" [ngStyle]="styleOuterShape('ss', geoLayerView.geoLayerSymbol)"/>
                </svg>
              </div>
              <ng-template #defaultLegend>
                <!-- Image -->
                  <img *ngIf="geoLayerView.geoLayerSymbol.properties.legendImagePath"
                  [src]="geoLayerView.geoLayerSymbol.properties.legendImagePath">
                <!-- Examine the geoLayerSymbol properties to determine if a default legend
                  symbol needs to be shown. -->
                  <svg *ngIf="geoLayerView.geoLayerSymbol.properties.symbolImage === undefined &&
                  geoLayerView.geoLayerSymbol.properties.builtinSymbolImage === undefined &&
                  geoLayerView.geoLayerSymbol.properties.legendImagePath === undefined &&
                  !getGeometryType(geoLayerView.geoLayerId).toUpperCase().includes('LINESTRING')"
                  class="layer-icon" width="18" height="18">
                    <rect width="18" height="18"
                    [ngStyle]="styleOuterShape('ss', geoLayerView.geoLayerSymbol)"/>
                  </svg>
              </ng-template>
            </div>

            <!-- CATEGORIZED -->
            <div *ngIf="'CATEGORIZED' | symbolCheck : geoLayerView.geoLayerSymbol">
              <div *ngIf="categorizedLayerColors[geoLayerView.geoLayerId]">
                <div *ngFor="let location of categorizedLayerColors[geoLayerView.geoLayerId]; let i = index">
                  <div *ngIf="(i % 2) === 0" class="cat-legend-features">
                    <!-- SQUARE will be default for polygons -->
                    <svg class="layer-icon" width="18" height="18">
                      <rect width="18" height="18"
                      [ngStyle]="styleOuterShape('c', categorizedLayerColors[geoLayerView.geoLayerId][i + 1])"/>
                    </svg>
                    {{location}}
                  </div>
                </div>
              </div>
            </div>

            <!-- GRADUATED -->
            <div *ngIf="'GRADUATED' | symbolCheck : geoLayerView.geoLayerSymbol">
              <!-- Does this need to be here? -->
              <div *ngIf="graduatedLayerColors[geoLayerView.geoLayerId]">
                <div *ngFor="let graduatedSymbolLine of graduatedLayerColors[geoLayerView.geoLayerId];"
                class="grad-legend-features">
                  <!-- SQUARE -->
                  <div *ngIf="'SQUARE' | symbolCheck : geoLayerView.geoLayerSymbol : graduatedSymbolLine">
                    <svg class='graduated-symbol' width="18" height="18">
                      <rect width="18" height="18" [ngStyle]="styleInnerShape('g', graduatedSymbolLine)"/>
                      <rect width="18" height="18" [ngStyle]="styleOuterShape('g', graduatedSymbolLine)"/>
                    </svg>
                    <div *ngIf="!graduatedSymbolLine.label; else displayLabel" class="grad-label">
                      {{graduatedSymbolLine | menuDisable: 'IMGradLabel' : geoLayerView.geoLayerId}}
                    </div>
                    <ng-template #displayLabel>
                      {{graduatedSymbolLine.label}}
                    </ng-template>
                  </div>
                  <!-- TRIANGLE -->
                  <div *ngIf="'TRIANGLE' | symbolCheck : geoLayerView.geoLayerSymbol : graduatedSymbolLine">
                    <svg class='graduated-symbol' height="18" width="18">
                      <polygon points="9,1 1,17 17,17" [ngStyle]="styleOuterShape('g', graduatedSymbolLine)"/>
                      <polygon points="9,1 1,17 17,17" [ngStyle]="styleInnerShape('g', graduatedSymbolLine)"/>
                    </svg>
                    <div *ngIf="!graduatedSymbolLine.label; else displayLabel" class="grad-label">
                      {{graduatedSymbolLine | menuDisable: 'IMGradLabel' : geoLayerView.geoLayerId}}
                    </div>
                    <ng-template #displayLabel>
                      {{graduatedSymbolLine.label}}
                    </ng-template>
                  </div>
                  <!-- CIRCLE -->
                  <div *ngIf="'CIRCLE' | symbolCheck : geoLayerView.geoLayerSymbol : graduatedSymbolLine">
                    <svg class='graduated-symbol' height="20" width="20">
                      <circle cx="10" cy="10" r="8" [ngStyle]="styleOuterShape('g', graduatedSymbolLine)"/>
                      <circle cx="10" cy="10" r="8" [ngStyle]="styleInnerShape('g', graduatedSymbolLine)"/>
                    </svg>
                    <div *ngIf="!graduatedSymbolLine.label; else displayLabel" class="grad-label">
                      {{graduatedSymbolLine | menuDisable: 'IMGradLabel' : geoLayerView.geoLayerId}}
                    </div>
                    <ng-template #displayLabel>
                      {{graduatedSymbolLine.label}}
                    </ng-template>
                  </div>
                </div>
              </div>
            </div>

            <!-- <div>
                <mat-progress-bar mode="indeterminate"></mat-progress-bar>
              </div> -->
            <div *ngIf="isServerUnavailable(geoLayerView.geoLayerId)"
            class="geoLayerView-status">
              <mat-icon matTooltip="Data service unavailable. Refresh at a later time"
              [matTooltipShowDelay]="250" data-cy="serverUnavailable">warning</mat-icon>
            </div>
            <div *ngIf="isBadPath(geoLayerView.geoLayerId)" class="geoLayerView-status">
              <mat-icon [matTooltip]="'Bad Resource Path: ' + getBadPath(geoLayerView.geoLayerId)"
              [matTooltipShowDelay]="250" data-cy="badPath">warning</mat-icon>
            </div>

          </div>

          <div *ngIf="lastRefresh[geoLayerView.geoLayerId]" class="refresh-container"
          id="refresh-{{geoLayerView.geoLayerId}}">
            Data last refreshed at {{lastRefresh[geoLayerView.geoLayerId]}}.
          </div>
        </ng-template>

      </div>

      <!-- Check if the layer is the only one, or the last one. If not, draw the
      divider so there can be something separating two layers. -->
      <hr *ngIf="numOfViews !== geoLayerViewGroup.geoLayerViews.length - 1" class="geoLayerView-divider">

    </div>

  </mat-expansion-panel>
</mat-accordion>
